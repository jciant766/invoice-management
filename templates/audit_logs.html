{% extends "base.html" %}

{% block title %}Audit Logs - Sliema Local Council{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Audit Logs</h1>
    <p class="text-gray-600">Track all system activity and changes</p>
</div>

<!-- Filters -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <form method="GET" action="/audit" class="flex flex-wrap gap-4 items-end">
        <!-- User Filter -->
        <div class="flex-1 min-w-[150px]">
            <label class="block text-sm font-medium text-gray-700 mb-1">User</label>
            <select name="user_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                <option value="">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if filters.user_id == user.id %}selected{% endif %}>
                    {{ user.username }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Action Filter -->
        <div class="flex-1 min-w-[150px]">
            <label class="block text-sm font-medium text-gray-700 mb-1">Action</label>
            <select name="action" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                <option value="">All Actions</option>
                {% for act in actions %}
                <option value="{{ act.value }}" {% if filters.action == act.value %}selected{% endif %}>
                    {{ act.label }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Entity Type Filter -->
        <div class="flex-1 min-w-[150px]">
            <label class="block text-sm font-medium text-gray-700 mb-1">Entity Type</label>
            <select name="entity_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                <option value="">All Types</option>
                {% for et in entity_types %}
                <option value="{{ et.value }}" {% if filters.entity_type == et.value %}selected{% endif %}>
                    {{ et.label }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Time Period Filter -->
        <div class="flex-1 min-w-[150px]">
            <label class="block text-sm font-medium text-gray-700 mb-1">Time Period</label>
            <select name="days" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                <option value="1" {% if filters.days == 1 %}selected{% endif %}>Last 24 hours</option>
                <option value="7" {% if filters.days == 7 %}selected{% endif %}>Last 7 days</option>
                <option value="30" {% if filters.days == 30 %}selected{% endif %}>Last 30 days</option>
                <option value="90" {% if filters.days == 90 %}selected{% endif %}>Last 90 days</option>
                <option value="" {% if not filters.days %}selected{% endif %}>All time</option>
            </select>
        </div>

        <button type="submit" class="bg-malta-blue text-white px-4 py-2 rounded-lg hover:bg-malta-blue-dark transition text-sm">
            Apply Filters
        </button>
        <a href="/audit" class="text-gray-600 hover:text-gray-800 px-4 py-2 text-sm">
            Clear
        </a>
    </form>
</div>

<!-- Results Count -->
<div class="mb-4 text-sm text-gray-600">
    Showing {{ logs|length }} of {{ pagination.total_count }} records
</div>

<!-- Logs Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP Address</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for log in logs %}
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                    {% if log.timestamp %}
                    {{ log.timestamp[:19].replace('T', ' ') }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm">
                    <span class="font-medium text-gray-900">{{ log.username }}</span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    {% set action_colors = {
                        'login': 'bg-green-100 text-green-800',
                        'login_failed': 'bg-red-100 text-red-800',
                        'logout': 'bg-gray-100 text-gray-800',
                        'invoice_create': 'bg-blue-100 text-blue-800',
                        'invoice_update': 'bg-yellow-100 text-yellow-800',
                        'invoice_delete': 'bg-red-100 text-red-800',
                        'invoice_status': 'bg-purple-100 text-purple-800',
                        'export': 'bg-cyan-100 text-cyan-800',
                        'settings_change': 'bg-orange-100 text-orange-800',
                        'user_create': 'bg-blue-100 text-blue-800',
                        'user_update': 'bg-yellow-100 text-yellow-800',
                        'user_delete': 'bg-red-100 text-red-800',
                        'password_change': 'bg-pink-100 text-pink-800'
                    } %}
                    <span class="px-2 py-1 text-xs font-medium rounded-full {{ action_colors.get(log.action, 'bg-gray-100 text-gray-800') }}">
                        {{ log.action | replace('_', ' ') | title }}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-600 max-w-md truncate" title="{{ log.details or '-' }}">
                    {{ log.details or '-' }}
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                    {{ log.ip_address or '-' }}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="px-4 py-12 text-center text-gray-500">
                    No audit logs found matching the selected filters.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if pagination.total_pages > 1 %}
<div class="mt-4 flex items-center justify-between">
    <div class="text-sm text-gray-600">
        Page {{ pagination.page }} of {{ pagination.total_pages }}
    </div>
    <div class="flex gap-2">
        {% if pagination.page > 1 %}
        <a href="?page={{ pagination.page - 1 }}{% if filters.user_id %}&user_id={{ filters.user_id }}{% endif %}{% if filters.action %}&action={{ filters.action }}{% endif %}{% if filters.entity_type %}&entity_type={{ filters.entity_type }}{% endif %}{% if filters.days %}&days={{ filters.days }}{% endif %}"
           class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-100">
            Previous
        </a>
        {% endif %}

        {% if pagination.page < pagination.total_pages %}
        <a href="?page={{ pagination.page + 1 }}{% if filters.user_id %}&user_id={{ filters.user_id }}{% endif %}{% if filters.action %}&action={{ filters.action }}{% endif %}{% if filters.entity_type %}&entity_type={{ filters.entity_type }}{% endif %}{% if filters.days %}&days={{ filters.days }}{% endif %}"
           class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-100">
            Next
        </a>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}
