{% extends "base.html" %}

{% block title %}Process Emails - Sliema Local Council{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Process Emails</h2>
            <p class="text-gray-600 mt-1">Forward invoice emails to create new records</p>
        </div>
        <a href="/invoices" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
            Back to Invoices
        </a>
    </div>

    <!-- Email Connection Card -->
    {% if not authenticated_email %}
    <div class="bg-white rounded-lg shadow p-6">
        <div class="text-center">
            <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Connect Your Email</h3>
            <p class="text-gray-600 mb-6">Connect your email account to start processing invoices</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                {% if oauth_configured.google %}
                <a href="/auth/google/login" class="inline-flex items-center justify-center gap-3 px-6 py-3 bg-white border-2 border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition shadow-sm">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span class="font-medium text-gray-700">Login with Google</span>
                </a>
                {% else %}
                <div class="inline-flex items-center justify-center gap-3 px-6 py-3 bg-gray-100 border-2 border-gray-200 rounded-lg text-gray-400 cursor-not-allowed">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span class="font-medium">Google (Not configured)</span>
                </div>
                {% endif %}

                {% if oauth_configured.microsoft %}
                <a href="/auth/microsoft/login" class="inline-flex items-center justify-center gap-3 px-6 py-3 bg-white border-2 border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition shadow-sm">
                    <svg class="w-5 h-5" viewBox="0 0 23 23">
                        <path fill="#f35325" d="M1 1h10v10H1z"/>
                        <path fill="#81bc06" d="M12 1h10v10H12z"/>
                        <path fill="#05a6f0" d="M1 12h10v10H1z"/>
                        <path fill="#ffba08" d="M12 12h10v10H12z"/>
                    </svg>
                    <span class="font-medium text-gray-700">Login with Microsoft</span>
                </a>
                {% else %}
                <div class="inline-flex items-center justify-center gap-3 px-6 py-3 bg-gray-100 border-2 border-gray-200 rounded-lg text-gray-400 cursor-not-allowed">
                    <svg class="w-5 h-5" viewBox="0 0 23 23">
                        <path fill="currentColor" d="M1 1h10v10H1z"/>
                        <path fill="currentColor" d="M12 1h10v10H12z"/>
                        <path fill="currentColor" d="M1 12h10v10H1z"/>
                        <path fill="currentColor" d="M12 12h10v10H12z"/>
                    </svg>
                    <span class="font-medium">Microsoft (Not configured)</span>
                </div>
                {% endif %}
            </div>
            {% if not oauth_configured.google and not oauth_configured.microsoft %}
            <p class="text-sm text-amber-600 mt-4">
                No OAuth providers configured. Add GOOGLE_CLIENT_ID/SECRET or MICROSOFT_CLIENT_ID/SECRET to your .env file.
            </p>
            {% endif %}
        </div>
    </div>
    {% else %}
    <!-- Connected Account Card -->
    <div class="bg-green-50 border border-green-200 rounded-lg shadow p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-green-100 rounded-lg">
                    {% if active_provider == 'google' %}
                    <svg class="w-6 h-6" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    {% elif active_provider == 'microsoft' %}
                    <svg class="w-6 h-6" viewBox="0 0 23 23">
                        <path fill="#f35325" d="M1 1h10v10H1z"/>
                        <path fill="#81bc06" d="M12 1h10v10H12z"/>
                        <path fill="#05a6f0" d="M1 12h10v10H1z"/>
                        <path fill="#ffba08" d="M12 12h10v10H12z"/>
                    </svg>
                    {% else %}
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    {% endif %}
                </div>
                <div>
                    <p class="text-sm text-green-600">Connected as</p>
                    <p class="font-semibold text-green-800">{{ authenticated_email }}</p>
                </div>
            </div>
            <a href="/auth/disconnect" onclick="return confirm('Disconnect your email account?')" class="px-4 py-2 text-sm font-medium text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition">
                Disconnect
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-100 rounded-lg">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Email Status</p>
                    <p class="font-semibold text-gray-800" id="emailStatus">{{ gmail_status }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-purple-100 rounded-lg">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">AI Status</p>
                    <p class="font-semibold text-gray-800" id="aiStatus">Checking...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Email List -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-4 border-b space-y-3">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <h3 class="font-bold text-gray-800">Emails</h3>
                        <span class="text-xs text-gray-500" id="selectedEmailCount"></span>
                    </div>
                    <button onclick="checkEmails()" class="bg-malta-blue text-white px-3 py-1.5 rounded-lg hover:bg-malta-blue-dark transition text-sm flex items-center gap-2" id="checkEmailsBtn">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
                <!-- Selection Actions -->
                <div class="flex gap-2" id="selectionActions" style="display: none;">
                    <button onclick="parseSelectedEmails()" class="bg-purple-600 text-white px-3 py-1.5 rounded-lg hover:bg-purple-700 transition text-sm flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        Parse Selected
                    </button>
                    <button onclick="clearEmailSelection()" class="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg hover:bg-gray-300 transition text-sm">
                        Clear Selection
                    </button>
                </div>
                <!-- Search Bar -->
                <div class="flex gap-2">
                    <input type="text" id="emailSearch" placeholder="Search emails (e.g., from:supplier, subject:invoice)"
                           class="flex-1 rounded-lg border-gray-300 shadow-sm focus:border-malta-blue focus:ring-malta-blue text-sm"
                           onkeypress="if(event.key==='Enter') searchEmails()">
                    <button onclick="searchEmails()" class="bg-purple-600 text-white px-3 py-1.5 rounded-lg hover:bg-purple-700 transition text-sm">
                        Search
                    </button>
                    <button onclick="clearSearch()" class="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg hover:bg-gray-300 transition text-sm">
                        Clear
                    </button>
                </div>
                <p class="text-xs text-gray-500" id="searchStatus">Showing unread emails</p>
            </div>
            <div class="divide-y max-h-[500px] overflow-y-auto" id="emailList">
                <div class="p-8 text-center text-gray-500">
                    {% if authenticated_email %}
                    <svg class="animate-spin w-8 h-8 mx-auto mb-4 text-malta-blue" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p>Loading emails...</p>
                    {% else %}
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <p>Connect your email to get started</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Invoice Form -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-4 border-b">
                <h3 class="font-bold text-gray-800">Create Invoice from Email</h3>
                <p class="text-sm text-gray-500 mt-1">Select an email to parse, then review and complete the form</p>
            </div>
            <div class="p-4" id="invoiceFormContainer">
                <div class="text-center text-gray-500 py-8">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>Select an email from the list to parse</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="bg-blue-50 rounded-lg p-4">
        <h4 class="font-semibold text-blue-800 mb-2">How to use:</h4>
        <ol class="list-decimal list-inside text-blue-700 space-y-1 text-sm">
            <li>Forward invoice emails to your connected email account</li>
            <li>Emails load automatically (or click "Refresh" to reload)</li>
            <li>Click "Parse" on an email to extract invoice data using AI</li>
            <li>Review the extracted data and fill in required fields (Invoice Number, PJV Number)</li>
            <li>Select or create a supplier, then submit to create the invoice</li>
        </ol>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 flex items-center gap-4">
        <svg class="animate-spin h-8 w-8 text-malta-blue" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-lg font-medium" id="loadingText">Loading...</span>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed top-4 right-4 z-50 hidden transform transition-all duration-300 translate-x-full">
    <div id="toastContent" class="rounded-lg shadow-lg p-4 max-w-md flex items-start gap-3">
        <div id="toastIcon" class="flex-shrink-0"></div>
        <div class="flex-1">
            <p id="toastTitle" class="font-semibold"></p>
            <p id="toastMessage" class="text-sm mt-1"></p>
        </div>
        <button onclick="hideToast()" class="flex-shrink-0 text-gray-400 hover:text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const suppliers = {{ suppliers | tojson | safe }};
const methodRequestCodes = {{ method_request_codes | tojson | safe }};
const methodProcurementCodes = {{ method_procurement_codes | tojson | safe }};

let currentEmailId = null;

// Check AI status and auto-load emails on page load
document.addEventListener('DOMContentLoaded', async () => {
    // Check AI status
    try {
        const response = await fetch('/email/test-ai');
        const data = await response.json();
        document.getElementById('aiStatus').textContent = data.success ? 'Connected' : 'Error';
        document.getElementById('aiStatus').className = data.success ? 'font-semibold text-green-600' : 'font-semibold text-red-600';
    } catch (e) {
        document.getElementById('aiStatus').textContent = 'Error';
        document.getElementById('aiStatus').className = 'font-semibold text-red-600';
    }

    // Auto-load emails if user is authenticated
    {% if authenticated_email %}
    // Small delay to let the page render first, then fetch emails in background
    setTimeout(() => {
        checkEmails();
    }, 100);
    {% endif %}
});

// ===== ERROR HANDLING FUNCTION =====
// This shows beautiful error modals instead of ugly Chrome errors
async function handleApiError(response) {
    try {
        const error = await response.json();

        // Check if it's our standardized error format
        if (error.error && error.error.message) {
            showErrorModal({
                title: getErrorTitle(error.error.type),
                message: error.error.message,
                details: error.error.details,
                action: error.error.user_action
            });
        } else if (error.error) {
            showError(error.error);
        } else {
            showError('An error occurred. Please try again.');
        }
    } catch (e) {
        showError(`Error: ${response.status} - ${response.statusText}`);
    }
}

function getErrorTitle(errorType) {
    const titles = {
        'validation_error': 'Validation Error',
        'ai_parsing_error': 'Unable to Parse Email',
        'database_error': 'Database Error',
        'email_service_error': 'Email Service Error',
        'not_found': 'Not Found',
        'internal_error': 'Server Error',
        'http_error': 'Request Error'
    };
    return titles[errorType] || 'Error';
}

function showErrorModal({title, message, details = {}, action = null}) {
    const existing = document.getElementById('errorModal');
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.id = 'errorModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
            <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full mb-4">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-bold text-gray-900 text-center mb-2">${title}</h3>
            <p class="text-gray-700 text-center mb-4">${message}</p>
            ${action ? `
                <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mb-4">
                    <p class="text-sm text-blue-700">
                        <strong>What to do:</strong> ${action}
                    </p>
                </div>
            ` : ''}
            ${Object.keys(details).length > 0 ? `
                <details class="mb-4">
                    <summary class="text-sm text-gray-500 cursor-pointer hover:text-gray-700">
                        Show technical details
                    </summary>
                    <pre class="text-xs bg-gray-100 p-2 rounded mt-2 overflow-auto max-h-32">${JSON.stringify(details, null, 2)}</pre>
                </details>
            ` : ''}
            <button onclick="document.getElementById('errorModal').remove()"
                    class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                Close
            </button>
        </div>
    `;

    document.body.appendChild(modal);

    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });

    const escHandler = (e) => {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
}

function showLoading(text = 'Loading...') {
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingOverlay').classList.remove('hidden');
    document.getElementById('loadingOverlay').classList.add('flex');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('loadingOverlay').classList.remove('flex');
}

// Toast notification system
let toastTimeout = null;

function showToast(type, title, message, duration = 5000) {
    const toast = document.getElementById('toast');
    const content = document.getElementById('toastContent');
    const icon = document.getElementById('toastIcon');
    const titleEl = document.getElementById('toastTitle');
    const messageEl = document.getElementById('toastMessage');

    // Set colors and icon based on type
    const styles = {
        error: {
            bg: 'bg-red-50 border border-red-200',
            title: 'text-red-800',
            message: 'text-red-600',
            icon: '<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        },
        success: {
            bg: 'bg-green-50 border border-green-200',
            title: 'text-green-800',
            message: 'text-green-600',
            icon: '<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        },
        warning: {
            bg: 'bg-amber-50 border border-amber-200',
            title: 'text-amber-800',
            message: 'text-amber-600',
            icon: '<svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>'
        },
        info: {
            bg: 'bg-blue-50 border border-blue-200',
            title: 'text-blue-800',
            message: 'text-blue-600',
            icon: '<svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        }
    };

    const style = styles[type] || styles.info;

    content.className = `rounded-lg shadow-lg p-4 max-w-md flex items-start gap-3 ${style.bg}`;
    icon.innerHTML = style.icon;
    titleEl.className = `font-semibold ${style.title}`;
    titleEl.textContent = title;
    messageEl.className = `text-sm mt-1 ${style.message}`;
    messageEl.textContent = message;

    // Show toast
    toast.classList.remove('hidden');
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 10);

    // Auto hide
    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => hideToast(), duration);
}

function hideToast() {
    const toast = document.getElementById('toast');
    toast.classList.add('translate-x-full');
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 300);
}

function showError(message) {
    showToast('error', 'Error', message, 6000);
}

function showSuccess(message) {
    showToast('success', 'Success', message, 4000);
}

async function checkEmails(query = null) {
    showLoading(query ? 'Searching emails...' : 'Checking emails...');

    try {
        const url = query ? `/email/check?q=${encodeURIComponent(query)}` : '/email/check';
        const response = await fetch(url);
        const data = await response.json();

        if (data.error) {
            showError(data.error);
            hideLoading();
            return;
        }

        // Emails are already grouped by thread on the backend
        const displayEmails = data.emails;

        // Update search status
        const statusText = data.query === 'is:unread'
            ? `Showing ${displayEmails.length} ${displayEmails.length === 1 ? 'thread' : 'threads'} (${data.count} total messages)`
            : `Found ${displayEmails.length} ${displayEmails.length === 1 ? 'thread' : 'threads'} for: "${data.query}"`;
        document.getElementById('searchStatus').textContent = statusText;

        const emailList = document.getElementById('emailList');

        if (displayEmails.length === 0) {
            emailList.innerHTML = `
                <div class="p-8 text-center text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                    </svg>
                    <p>No emails found</p>
                </div>
            `;
        } else {
            emailList.innerHTML = displayEmails.map(email => `
                <div class="p-4 hover:bg-gray-50 border-l-4 ${email.thread_count > 1 ? 'border-purple-400 bg-purple-50/30' : 'border-transparent'}" data-email-id="${email.id}" data-thread-id="${email.thread_id}">
                    <div class="flex items-start gap-3">
                        <!-- Checkbox -->
                        <input type="checkbox" class="email-checkbox mt-1 rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                               value="${email.id}"
                               data-thread-id="${email.thread_id}"
                               onchange="updateEmailSelection()"
                               onclick="event.stopPropagation()">

                        <!-- Content -->
                        <div class="flex-1 min-w-0 cursor-pointer" onclick="selectEmail('${email.id}')">
                            <div class="flex items-start gap-2">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        ${email.thread_count > 1 ? `
                                            <svg class="w-4 h-4 text-purple-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Thread with ${email.thread_count} messages">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                            </svg>
                                            <span class="text-xs font-semibold text-purple-600 bg-purple-100 px-1.5 py-0.5 rounded">${email.thread_count} messages</span>
                                        ` : ''}
                                    </div>
                                    <p class="font-medium text-gray-900 truncate">${escapeHtml(email.subject)}</p>
                                    <p class="text-sm text-gray-500 truncate">${escapeHtml(email.from)}</p>
                                    <p class="text-xs text-gray-400 mt-1">${email.date}</p>
                                    ${email.thread_count > 1 ? `
                                        <p class="text-xs text-purple-600 mt-1">üìß Conversation thread - Click Parse to analyze all ${email.thread_count} messages</p>
                                    ` : ''}
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mt-2 line-clamp-2">${escapeHtml(email.snippet)}</p>
                        </div>

                        <!-- Parse Button -->
                        <button onclick="event.stopPropagation(); parseEmail('${email.id}')" class="ml-2 bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition whitespace-nowrap">
                            Parse
                        </button>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        showError('Error checking emails: ' + error.message);
    }

    hideLoading();
}

function searchEmails() {
    const query = document.getElementById('emailSearch').value.trim();
    if (query) {
        checkEmails(query);
    } else {
        checkEmails(); // Default to unread
    }
}

function clearSearch() {
    document.getElementById('emailSearch').value = '';
    checkEmails(); // Reset to unread emails
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function selectEmail(emailId) {
    // Highlight selected email
    document.querySelectorAll('#emailList > div').forEach(el => {
        el.classList.remove('bg-blue-50', 'border-l-4', 'border-malta-blue');
    });
    event.currentTarget.classList.add('bg-blue-50', 'border-l-4', 'border-malta-blue');
}

async function parseEmail(emailId) {
    currentEmailId = emailId;
    showLoading('AI is parsing the email...');

    try {
        const response = await fetch(`/email/parse/${emailId}`, { method: 'POST' });

        // Check if response failed - use our new error handling!
        if (!response.ok) {
            hideLoading();
            await handleApiError(response);  // This shows a nice modal instead of ugly Chrome error
            return;
        }

        const data = await response.json();

        if (data.error) {
            // Old error format - still handle it
            showError(data.error);
            hideLoading();
            return;
        }

        showInvoiceForm(data.invoice_data);
    } catch (error) {
        showError('Error parsing email: ' + error.message);
    }

    hideLoading();
}

function showInvoiceForm(invoiceData, currentIndex = -1, totalCount = 1) {
    const container = document.getElementById('invoiceFormContainer');

    // Build supplier options
    let supplierOptions = '<option value="">-- Select Supplier --</option>';
    supplierOptions += '<option value="-1">+ Add New Supplier</option>';

    // Check if extracted supplier matches any existing
    let matchedSupplierId = '';
    suppliers.forEach(s => {
        const isMatch = s.name.toLowerCase().includes(invoiceData.supplier_name.toLowerCase()) ||
                       invoiceData.supplier_name.toLowerCase().includes(s.name.toLowerCase());
        if (isMatch && !matchedSupplierId) matchedSupplierId = s.id;
        supplierOptions += `<option value="${s.id}" ${isMatch ? 'selected' : ''}>${escapeHtml(s.name)}</option>`;
    });

    // Build method request options
    let methodRequestOptions = '';
    Object.entries(methodRequestCodes).forEach(([code, desc]) => {
        methodRequestOptions += `<option value="${code}" ${code === invoiceData.method_request ? 'selected' : ''}>${code} - ${desc}</option>`;
    });

    // Build method procurement options
    let methodProcOptions = '';
    Object.entries(methodProcurementCodes).forEach(([code, desc]) => {
        methodProcOptions += `<option value="${code}" ${code === invoiceData.method_procurement ? 'selected' : ''}>${code} - ${desc}</option>`;
    });

    // Navigation header for multi-parsing
    const navigationHeader = currentIndex >= 0 ? `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-blue-900">Email ${currentIndex + 1} of ${totalCount}</span>
                <div class="flex gap-2">
                    <button type="button" onclick="showPreviousParsedEmail()" ${currentIndex === 0 ? 'disabled' : ''} class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        ‚Üê Previous
                    </button>
                    <button type="button" onclick="skipCurrentParsedEmail()" class="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600">
                        Skip ‚Üí
                    </button>
                    <button type="button" onclick="showNextParsedEmail()" ${currentIndex >= totalCount - 1 ? 'disabled' : ''} class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>
    ` : '';

    container.innerHTML = `
        ${navigationHeader}
        <form id="invoiceForm" class="space-y-4">
            <input type="hidden" name="email_id" value="${invoiceData.email_id || currentEmailId}">

            <!-- Thread Info -->
            ${invoiceData.thread_count > 1 ? `
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 mb-2">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                        </svg>
                        <span class="text-sm font-medium text-purple-900">Thread with ${invoiceData.thread_count} messages analyzed</span>
                    </div>
                </div>
            ` : ''}

            <!-- AI Confidence -->
            <div class="bg-purple-50 rounded-lg p-3 mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-purple-700 font-medium">AI Confidence:</span>
                    <div class="flex-1 bg-purple-200 rounded-full h-2">
                        <div class="bg-purple-600 h-2 rounded-full" style="width: ${invoiceData.confidence_score * 100}%"></div>
                    </div>
                    <span class="text-purple-700 font-medium">${Math.round(invoiceData.confidence_score * 100)}%</span>
                </div>
                ${invoiceData.notes ? `<p class="text-sm text-purple-600 mt-2">${escapeHtml(invoiceData.notes)}</p>` : ''}
            </div>

            <!-- Extracted Supplier Name (for reference) -->
            <div class="bg-gray-50 rounded-lg p-3">
                <p class="text-sm text-gray-500">Extracted Supplier Name:</p>
                <p class="font-medium">${escapeHtml(invoiceData.supplier_name)}</p>
            </div>

            <!-- Supplier Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Supplier *</label>
                <select name="supplier_id" id="supplierSelect" onchange="toggleNewSupplier()" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-malta-blue focus:ring-malta-blue">
                    ${supplierOptions}
                </select>
            </div>

            <div id="newSupplierDiv" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">New Supplier Name</label>
                <input type="text" name="new_supplier_name" value="${escapeHtml(invoiceData.supplier_name)}" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-malta-blue focus:ring-malta-blue">
            </div>

            <!-- Amounts -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Amount *</label>
                    <input type="number" name="invoice_amount" value="${invoiceData.invoice_amount}" step="0.01" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-malta-blue focus:ring-malta-blue">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Amount *</label>
                    <input type="number" name="payment_amount" value="${invoiceData.payment_amount}" step="0.01" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-malta-blue focus:ring-malta-blue">
                </div>
            </div>

            <!-- Methods -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Method Request *</label>
                    <select name="method_request" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-malta-blue focus:ring-malta-blue">
                        ${methodRequestOptions}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Procurement Method *</label>
                    <select name="method_procurement" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-malta-blue focus:ring-malta-blue">
                        ${methodProcOptions}
                    </select>
                </div>
            </div>

            <!-- Description -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description *</label>
                <textarea name="description" rows="2" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-malta-blue focus:ring-malta-blue">${escapeHtml(invoiceData.description)}</textarea>
            </div>

            <!-- Invoice Date and Number -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Date *</label>
                    <input type="date" name="invoice_date" value="${invoiceData.invoice_date}" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-malta-blue focus:ring-malta-blue">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Number * <span class="text-amber-600">(Manual)</span></label>
                    <input type="text" name="invoice_number" value="${escapeHtml(invoiceData.invoice_number || '')}" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-malta-blue focus:ring-malta-blue bg-amber-50">
                </div>
            </div>

            <!-- PO and PJV Numbers -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">PO Number (optional)</label>
                    <input type="text" name="po_number" value="${escapeHtml(invoiceData.po_number || '')}" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-malta-blue focus:ring-malta-blue">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">PJV Number * <span class="text-amber-600">(Manual)</span></label>
                    <input type="text" name="pjv_number" required placeholder="Enter PJV number" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-malta-blue focus:ring-malta-blue bg-amber-50">
                </div>
            </div>

            <!-- Submit -->
            <div class="pt-4 flex gap-3">
                <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                    Create Invoice
                </button>
                <button type="button" onclick="markAsRead()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                    Skip & Mark Read
                </button>
            </div>
        </form>
    `;

    // Toggle new supplier field if -1 is pre-selected
    if (!matchedSupplierId) {
        document.getElementById('supplierSelect').value = '-1';
        toggleNewSupplier();
    }

    // Add form submit handler
    document.getElementById('invoiceForm').addEventListener('submit', submitInvoice);
}

function toggleNewSupplier() {
    const select = document.getElementById('supplierSelect');
    const div = document.getElementById('newSupplierDiv');
    div.classList.toggle('hidden', select.value !== '-1');
}

async function submitInvoice(e) {
    e.preventDefault();
    showLoading('Creating invoice...');

    const formData = new FormData(e.target);

    try {
        const response = await fetch('/email/create-invoice', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            showSuccess(data.message);
            setTimeout(() => {
                window.location.href = data.redirect || '/invoices';
            }, 1500);
        } else {
            let errorMsg = 'Error creating invoice';
            if (data.errors) {
                const errorDetails = Object.entries(data.errors).map(([field, msg]) => `${field}: ${msg}`).join(', ');
                errorMsg += ': ' + errorDetails;
            }
            showError(errorMsg);
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }

    hideLoading();
}

async function markAsRead() {
    if (!currentEmailId) return;

    showLoading('Marking as read...');

    try {
        const response = await fetch(`/email/mark-read/${currentEmailId}`, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showSuccess('Email marked as read');
            checkEmails(); // Refresh list
            document.getElementById('invoiceFormContainer').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>Select an email from the list to parse</p>
                </div>
            `;
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }

    hideLoading();
}

// Email selection functions
function updateEmailSelection() {
    const checkboxes = document.querySelectorAll('.email-checkbox:checked');
    const count = checkboxes.length;

    const countDisplay = document.getElementById('selectedEmailCount');
    const actionsDiv = document.getElementById('selectionActions');

    if (count > 0) {
        countDisplay.textContent = `(${count} selected)`;
        actionsDiv.style.display = 'flex';
    } else {
        countDisplay.textContent = '';
        actionsDiv.style.display = 'none';
    }
}

function clearEmailSelection() {
    document.querySelectorAll('.email-checkbox').forEach(cb => cb.checked = false);
    updateEmailSelection();
}

function getSelectedEmailIds() {
    const checkboxes = document.querySelectorAll('.email-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// Parse selected emails sequentially
let currentParsingIndex = 0;
let parsedResults = [];

async function parseSelectedEmails() {
    const emailIds = getSelectedEmailIds();

    if (emailIds.length === 0) {
        showError('No emails selected');
        return;
    }

    if (!confirm(`Parse ${emailIds.length} selected email${emailIds.length > 1 ? 's' : ''}? You'll review each one before creating the invoice.`)) {
        return;
    }

    currentParsingIndex = 0;
    parsedResults = [];

    showLoading(`Parsing email 1 of ${emailIds.length}...`);

    try {
        const response = await fetch('/email/parse-multiple', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email_ids: emailIds })
        });

        // Check if response failed - use our new error handling!
        if (!response.ok) {
            hideLoading();
            await handleApiError(response);  // Show nice modal instead of ugly error
            return;
        }

        const data = await response.json();

        if (data.success) {
            parsedResults = data.results.filter(r => r.success);

            if (parsedResults.length === 0) {
                hideLoading();
                showError('None of the selected emails could be parsed. They may not contain invoice information.');
                return;
            }

            hideLoading();
            showSuccess(`Successfully parsed ${parsedResults.length} of ${emailIds.length} emails!`);

            // Show first result
            if (parsedResults.length > 0) {
                showInvoiceForm(parsedResults[0].invoice_data, 0, parsedResults.length);
            }
        } else {
            hideLoading();
            showError(data.error || 'Failed to parse emails');
        }
    } catch (error) {
        hideLoading();
        showError('Error parsing emails: ' + error.message);
    }
}

// Navigation for multi-parsing results
function showNextParsedEmail() {
    if (currentParsingIndex < parsedResults.length - 1) {
        currentParsingIndex++;
        showInvoiceForm(parsedResults[currentParsingIndex].invoice_data, currentParsingIndex, parsedResults.length);
    }
}

function showPreviousParsedEmail() {
    if (currentParsingIndex > 0) {
        currentParsingIndex--;
        showInvoiceForm(parsedResults[currentParsingIndex].invoice_data, currentParsingIndex, parsedResults.length);
    }
}

function skipCurrentParsedEmail() {
    if (currentParsingIndex < parsedResults.length - 1) {
        showNextParsedEmail();
    } else {
        // Last one - clear form
        document.getElementById('invoiceFormContainer').innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <svg class="w-12 h-12 mx-auto mb-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="font-medium text-gray-700">All emails processed!</p>
                <p class="text-sm mt-2">Select more emails to parse or check for new messages.</p>
            </div>
        `;
        clearEmailSelection();
        currentParsingIndex = 0;
        parsedResults = [];
    }
}
</script>
{% endblock %}
